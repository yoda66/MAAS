stages:
    - PreProcess
    - BakeMalware
    - PostProcess

workflow:
    rules:
        - changes:
            - shellcode/*

PreProcess:
    stage: PreProcess
    tags:
        - maas
    script:
        - |
            mkdir /payloads/${CI_COMMIT_SHORT_SHA}
            ln -s /payloads/.lib/garble /payloads/${CI_COMMIT_SHORT_SHA}/.lib
            [ -f "/payloads/.lib/garble" ] && exit
            mkdir -p /payloads/.lib
            export GOBIN=/payloads/.lib
            go install mvdan.cc/garble@latest

ScareCrow:
    stage: BakeMalware
    tags:
        - maas
    script:
        - |
            cd /payloads/${CI_COMMIT_SHORT_SHA}
            ScareCrow -I $CI_PROJECT_DIR/shellcode/notepad_x64.bin -Loader binary -nosign
            ls -al /payloads

PostProcess:
    stage: PostProcess
    tags:
        - maas
    script:
        - |
            echo "Creating ZIP file"
